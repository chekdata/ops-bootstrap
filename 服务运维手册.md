服务运维手册（frontend-miker｜dev/staging/prod）

一、概览
- 架构：Next.js（端口 3000）→ Service NodePort:80→3000 → Ingress（ALB，target-type=instance）。
- 环境与域名：
  - dev：`miker-dev.chekkk.com`
  - staging：`miker-staging.chekkk.com`
  - prod：`miker.chekkk.com`（80=301→443，业务只在 443）

二、日常发布（PR 合并自动发布）
1) 合并到 dev/staging/main → Actions 触发 `ci`：构建并推 VECR（tags：`sha-<short>`，dev/staging 追加 `*-latest`）。
2) `deploy` 通过 `workflow_run`（ci 成功后）自动部署目标环境：
   - 等待镜像可用（manifest inspect 重试）
   - 命名空间自动创建（`miker-<env>`）
   - 应用 Service/Deployment/Ingress（NodePort/instance 模式，端口 3000）
3) 验证：
   - `kubectl -n miker-<env> rollout status deploy/frontend-miker`
   - `curl -I http(s)://<域名>/`（dev 可能 307，staging/prod 200）

三、回滚
1) 找到上一个稳定镜像：Actions → `ci` 运行 → 复制 `sha-<short>`。
2) 临时回滚（kubectl）：
   ```bash
   kubectl -n miker-<env> set image deploy/frontend-miker app=chek-images-cn-beijing.cr.volces.com/prod/frontend-miker:sha-<short>
   kubectl -n miker-<env> rollout status deploy/frontend-miker
   ```
3) 持久化：将该 sha 提交到部署清单/工作流参数（或通过 CI 重新发布）保持一致性。

四、故障排查（快捷清单）
- 503/超时
  - `kubectl -n miker-<env> get po,svc,ing` → Deployment Ready=1/1？
  - `kubectl -n miker-<env> get endpoints frontend-miker -o wide` → 容器端口=3000？
  - `kubectl -n miker-<env> describe ing frontend-miker` → 注解为 `target-type: instance`/`address-type: internet`；ALB 事件无健康检查错误？
  - 节点安全组：是否放通“ALB 安全组 → NodePort 段（30000–32767/TCP 或实际端口）”
- 容器探针失败
  - `kubectl -n miker-<env> logs deploy/frontend-miker --tail=200`
  - 探针路径/端口对齐 3000，镜像是否对应最新 sha
- 域名异常
  - `nslookup <域名>` → 指向 ALB FQDN（CNAME），非 A 到 EIP
  - `curl -H 'Host: <域名>' http://<ALB-IP>/ -I` → 验证 80/443 路由是否命中预期后端

五、飞书与 YApi（自动链路）
- 飞书拉群+通知（组织级）
  - 条件：业务仓 Secrets 配置 `FEISHU_CHAT_ID_PROD`、`GITOPS_PAT`
  - 业务仓 `notify-dispatch.yml` 在 CI/Deploy 成功后自动 `repository_dispatch` 到组织仓；组织仓入口工作流完成“成员同步入群 + 卡片通知”
  - 验证：组织仓 `.github` → Actions → Org Feishu Sync Members（`sync=success`、`notify=success`；Artifacts 三份诊断文件）
- YApi 同步
  - 建议接入组织级工作流：CI 成功后自动 dispatch 导入 OpenAPI
  - 验证：`https://yapi.chekkk.com/project/<id>/interface/api` 能看到最新接口；Actions 日志包含 “YApi synchronization successful.”

六、镜像仓库（VECR）治理
- 仓库：`chek-images-cn-beijing.cr.volces.com/prod/frontend-miker`
- 保留策略：`dev-latest`、`stg-latest` 与最近 15 个 `sha-*`；更旧 `sha-*` 定期清理（不触碰自定义标签）
- 审计脚本：只读列出与清理计划，默认不删除；需要时逐条删除（保守执行）

七、常用命令（速查）
```bash
# 发布状态
kubectl -n miker-<env> get deploy,po,svc,ingress
kubectl -n miker-<env> rollout status deploy/frontend-miker

# Ingress/ALB 诊断
kubectl -n miker-<env> describe ing frontend-miker | sed -n '1,160p'

# Service/Endpoints
kubectl -n miker-<env> get svc frontend-miker -o wide
kubectl -n miker-<env> get endpoints frontend-miker -o yaml | sed -n '1,80p'

# 覆盖镜像（临时回滚/前推）
kubectl -n miker-<env> set image deploy/frontend-miker app=chek-images-cn-beijing.cr.volces.com/prod/frontend-miker:sha-<short>

# 外部验证
curl -I -L --max-time 10 http://miker-<env>.chekkk.com/
```

八、SLO 与告警（建议）
- 可用性：月度 ≥ 99.9%（业务 200/3xx）；探针/页面失败率阈值告警
- 部署：rollout 超时/失败自动告警；自动回滚开关按业务重要度评估
- 入站：ALB 目标组不健康数、5xx/4xx（维度：Listener/Rule/ServerGroup）

服务运维手册（ALB / Ingress / 前端与 YApi 运行手册）

一、目标与范围
- 统一外部入口通过 ALB 承载，按环境（dev/staging/prod）独立实例、独立 IngressClass。
- 80 仅用作 HTTP→HTTPS 301，业务路径集中在 443。
- GitOps 为单一真源：Ingress/Service/证书/工作流全部入库，禁止控制台手工改规则（仅应急）。

二、常用路径与凭据位置
- Kubeconfig（只读/运维）：`tools/kube-conf/chek-<env>-k8s-public-kube.conf`
- GitOps 仓：`ops-bootstrap`（当前仓库）
- 预签名校验与清理脚本：`tmp/alb_verify_hosts.py`、`tmp/sg_scan.py`、`tmp/sg_delete_empty.py`

三、日常巡检（每日）
1) 预签名校验 ALB（80/443）：
   ```bash
   source tmp/venv/bin/activate
   export VOLC_AK=<RO_AK> VOLC_SK=<RO_SK> REGION=cn-beijing
   export ALB_PROD=<alb-prod-id> ALB_STAGING=<alb-stg-id> ALB_DEV=<alb-dev-id>
   export HOSTS=yapi.chekkk.com,app.chekkk.com,www.chekkk.com,app-staging.chekkk.com,www-staging.chekkk.com,app-dev.chekkk.com,www-dev.chekkk.com
   python tmp/alb_verify_hosts.py > /tmp/alb_verify.json
   ```
   - 期望：80 下无业务 ServerGroup（仅 redirect）；443 命中业务目标组且健康>0。
2) Ingress/Service 健康：
   ```bash
   KUBECONFIG=tools/kube-conf/chek-<env>-k8s-public-kube.conf \
     kubectl -n <ns> get ingress,svc,endpoints
   ```
   - 期望：Endpoints Ready 数量>0，Ingress 不处于 Deleting。

四、问题定位与修复
A. 80 返回 200 非 301
- 现象：HTTP 未经 ALB，或 80 存在业务规则。
- 排查：
  - DNS：确认域名为 CNAME → 对应环境 ALB 域名（不要 A 到 EIP）。
  - Ingress：80 侧 Ingress 仅有 `/ -> ssl-redirect:80`，注解包含 `ingress.vke.volcengine.com/actions.ssl-redirect` 与 `listen-ports: [{"HTTP":80}]`。
  - 预签名：确认 80 下无业务 ServerGroup。
- 修复：更新 Ingress（GitOps），合并后等待控制器收敛；必要时临时删除 80 下的业务规则（仅应急，随后回归 GitOps）。

B. 443 规则竞争/落入默认后端
- 现象：返回控制台默认页/404。
- 排查：是否缺少 `group.name/group.order` 或未显式 `listen-ports: [{"HTTPS":443}]`。
- 修复：在 443 的 Ingress 上补齐分组与优先级；单域尽量单 Ingress，确保 host-header 明确命中。

C. Admission 报错 “svc [...] has no port [0]”
- 原因：Ingress backend 使用 `port.name` 或 `use-annotation`。
- 修复：将后端端口改为数值 `number: 80`；`ssl-redirect` Service 使用 `port:80/targetPort:80`。

D. 503/502
- 现象：目标组无健康实例或后端拒绝。
- 排查：
  - Service selector → Endpoints；
  - Service `targetPort` 与容器端口一致；
  - 节点安全组是否放通 ALB 安全组到 NodePort 段；
  - 控制器日志是否提示 “no endpoints available”。
- 修复：修正 selector/端口，放通 SG；必要时重建 Ingress 以刷新目标组。

E. yapi 登录/302 到 `/feishu-sso/`
- 解释：应用内 SSO 插件行为（非 ALB）；`/user/login` 302 到 SSO 回调属预期。
- 健康检查：可用 `/user/login`（成功码 200,301,302）。
- 根路径：如监听 3000，使用 `yapi-web`（NodePort 80→3000）承载 `/`。

五、例行清理（每周）
1) 扫描空/不健康 ServerGroups（仅报告）：
   ```bash
   source tmp/venv/bin/activate
   export VE_REGION=cn-beijing VE_AK=<AK> VE_SK=<SK> ALB_PROD=<id>
   python tmp/sg_scan.py > /tmp/sg_candidates.json
   ```
2) 删除空目标组（谨慎，仅当未被规则引用）：
   ```bash
   export CANDIDATES_JSON="$(cat /tmp/sg_candidates.json)"
   python tmp/sg_delete_empty.py
   ```
3) 准则：被规则引用/健康>0 的目标组禁止删除；如需替换，先在 GitOps 中切换 Ingress/Service，待控制器生成替代组后再清理。

六、CI/CD 与 GitOps（前端）
- 应用仓工作流：构建并推 VECR → `repository_dispatch` 通知 GitOps 仓。
- GitOps 仓工作流：接收事件 → 运行 `tmp/update_manifests.py` 更新各环境镜像 → 创建带 `automerge` 标签的 PR → 自动合并 → Argo CD 同步。
- 必需 Secrets：
  - 应用仓：`VE_REGISTRY/VE_USERNAME/VE_PASSWORD/GITOPS_PAT`
  - GitOps 仓：`GITOPS_PAT`（用于创建/合并 PR）

七、DNS 规范（外部 DNS 如腾讯云）
- 建议使用 CNAME 指向 ALB 域名；TTL 60–300。
- 禁止 A 到 EIP（EIP 可能漂移；CNAME 更稳）。
- 分环境域名：`<svc>-dev|staging.chekkk.com`、生产 `app/www/yapi.chekkk.com`。

八、应急操作（尽量 24–48 小时内回归 GitOps）
- 临时在控制台删除 80 下的业务转发或修正 443 的 host 规则，以恢复服务；完成后立即将变更写回 Ingress，并清理手工规则。

九、附录：命令速查
```bash
# 应用最新 Ingress/Service（dev）
KUBECONFIG=tools/kube-conf/chek-dev-k8s-public-kube.conf \
kubectl apply -f frontend-app-dev -f frontend-saas-dev

# 预签名校验（prod/app/www/yapi）
source tmp/venv/bin/activate
export VOLC_AK=<RO_AK> VOLC_SK=<RO_SK> REGION=cn-beijing ALB_PROD=<alb-id>
export HOSTS=app.chekkk.com,www.chekkk.com,yapi.chekkk.com
python tmp/alb_verify_hosts.py | tee /tmp/alb_verify_prod.json
```

十、飞书通知与自动拉群（组织级复用）
- 入口工作流：组织仓 `.github/workflows/org-feishu-notify-sync.yml`
  - 触发：`repository_dispatch`（type: `feishu-ci-notify`）或手动 `workflow_dispatch`
  - Jobs：
    - `sync`：部门枚举 → `nickname == GitHub 登录名（小写）` 命中 → 以 `open_id` 将成员加入 `chat_id`
      - 产物：`feishu_diag.json`、`feishu_nicknames.json`、`feishu_sync_summary.json`
    - `notify`：调用 `reusable-feishu-ci-notify.yml` 发送卡片
- 仓库侧接入：在应用仓配置 `FEISHU_CHAT_ID_PROD`、`GITOPS_PAT`，并添加 `notify-dispatch.yml`（监听主 CI/CD 成功后派发）
- 常见故障：
  - 未入群但成功：多为 `chat_id` 为空 → 检查应用仓 `FEISHU_CHAT_ID_PROD`
  - 命中人数少：成员飞书昵称与 GitHub 登录名不一致 → 统一昵称为登录名（小写）
  - 未收到通知：确认组织级存在 `notify` 作业，且应用仓已派发到 `.github`

十一、GitHub 清理 SOP（保守）
- 工作流（Workflows）
  - 保留：主发布（如 `cd-on-merge`）、组织派发（`notify-dispatch`）、飞书通知（`feishu-notify`）
  - 候选禁用：90–120 天无运行或已被替换的工作流；先“禁用”观察，再考虑删除 YAML
- 分支（Branches）
  - 保留：`main/master`、`develop`、`dev/staging` 等主分支
  - 候选删除：前缀 `fix-/feat-/ci-/deploy-/temp-/test-/hotfix-/chore-/revert-`，且
    - 非开放 PR 的 head；且最近提交超过 7–14 天；且已不在发布计划
  - 删除顺序：先在仓库“分支保护”放开限制 → 删除 → 恢复保护
- PR（Pull Requests）
  - 仅关闭部署脚手架/临时性 PR 且无后续计划的；保留功能/修复类
  - 关闭前在描述中补上原因与链接，便于审计

十二、VECR 镜像清理 SOP（前置条件）
- 当前镜像“免密拉取”不等于“匿名可列举/删除”，列举/删除需具备权限：
  - 任选其一：机器人账号 token（含 delete）/ OpenAPI AKSK（镜像仓库读删）/ 开启匿名列表权限
- 清理策略（具备权限后）：
  - 标签匹配：`tmp|temp|test|ci|pr|dev|staging` 等临时/环境标签
  - 过期策略：非活跃 > 30/60 天；同一基线仅保留最近 N 个版本
  - 执行方式：先生成计划（dry-run 报表）→ 人工确认 → 批量删除
- 审计与回溯：输出“仓库/标签/创建时间/最后拉取时间/删除人/时间”到报表归档

十三、DNS 运维规范
- 权威 DNS：放在“腾讯云”，火山引擎侧不再新建 A 记录
- 外部解析：一律 CNAME 到 ALB 域名；TTL 建议 300（60–300 视情况）
- 变更窗口：在低峰变更；变更后执行外网与集群内双路径验证

十四、夜间校验与每周清理（作业落地）
- Nightly 验证（组织级）
  - 校验监听器 80/443、规则 host-header 命中、ServerGroup 健康
  - 产物作为告警输入；失败需创建问题单并在 24h 内处理
- Weekly 清理
  - 空/不健康 ServerGroup 定位与清理（遵循“未被规则引用/无健康实例”原则）
  - 配合 GitOps 变更：先切流再删组，避免流量中断

