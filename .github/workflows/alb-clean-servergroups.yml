name: ALB ServerGroups Cleanup
on:
  schedule:
    - cron: '10 19 * * 6' # Weekly Sun 03:10 CST
  workflow_dispatch:
    inputs:
      execute:
        description: 'Actually delete empty/unhealthy ServerGroups (true/false)'
        required: false
        default: 'false'
jobs:
  cleanup:
    runs-on: ubuntu-latest
    env:
      AK: ${{ secrets.VE_AK }}
      SK: ${{ secrets.VE_SK }}
      REGION: cn-beijing
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install volcengine
      - name: Scan and optionally delete
        env:
          EXECUTE: ${{ github.event.inputs.execute || 'false' }}
        run: |
          python - <<'PY'
          import os, json, urllib.request
          from volcengine.Credentials import Credentials
          from volcengine.base.Request import Request
          from volcengine.auth.SignerV4 import SignerV4
          ak=os.environ['AK']; sk=os.environ['SK']; region=os.environ.get('REGION','cn-beijing'); execute=os.environ.get('EXECUTE','false').lower()=='true'
          def presign(action, **query):
              ep=f"alb.{region}.volcengineapi.com"
              req=Request(); req.method='GET'; req.host=ep; req.path='/'
              q={'Action':action,'Version':'2020-04-01','Region':region}; q.update({k:str(v) for k,v in query.items()})
              req.query=q; req.headers={'Host':ep}
              cred=Credentials(ak, sk, service='alb', region=region)
              return f"https://{ep}/?"+SignerV4.sign_url(req, cred)
          def get(url): return json.loads(urllib.request.urlopen(url, timeout=60).read().decode())
          def servers(sg): return get(presign('DescribeServers', ServerGroupId=sg))['Result'].get('Servers',[]) or []
          # paginate SGs
          sgs=[]; page=1
          while True:
              data=get(presign('DescribeServerGroups', PageNumber=str(page), PageSize='200'))
              arr=data.get('Result',{}).get('ServerGroups',[]) or []
              sgs.extend(arr)
              if len(arr)<200: break
              page+=1
          report={'candidates':[],'deleted':[]}
          for sg in sgs:
              sgid=sg.get('ServerGroupId'); name=sg.get('ServerGroupName','')
              ss=servers(sgid)
              healthy=sum(1 for s in ss if s.get('Status')=='Healthy')
              total=len(ss)
              if total==0 or healthy==0:
                  report['candidates'].append({'id':sgid,'name':name,'total':total,'healthy':healthy})
                  if execute and total==0:
                      # Delete only empty SGs for safety
                      del_url=presign('DeleteServerGroup', ServerGroupId=sgid)
                      try:
                          get(del_url)
                          report['deleted'].append(sgid)
                      except Exception as e:
                          report['deleted'].append({'id':sgid,'error':str(e)})
          print(json.dumps(report, ensure_ascii=False, indent=2))
          open('alb-clean-sg-report.json','w').write(json.dumps(report, ensure_ascii=False, indent=2))
          PY
      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: alb-clean-sg-report
          path: alb-clean-sg-report.json

