name: ALB Nightly Validate
on:
  schedule:
    - cron: '20 18 * * *' # 02:20 CST daily
  workflow_dispatch:
    inputs:
      envs:
        description: 'Envs to check (comma, default: prod,staging,dev)'
        required: false
        default: 'prod,staging,dev'
jobs:
  validate:
    runs-on: ubuntu-latest
    env:
      AK: ${{ secrets.VE_AK }}
      SK: ${{ secrets.VE_SK }}
      REGION: cn-beijing
      ALB_PROD: ${{ vars.ALB_PROD }}
      ALB_STAGING: ${{ vars.ALB_STAGING }}
      ALB_DEV: ${{ vars.ALB_DEV }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install volcengine
      - name: Validate listeners (summary)
        run: |
          python - <<'PY'
          import os, json, urllib.request
          from volcengine.Credentials import Credentials
          from volcengine.base.Request import Request
          from volcengine.auth.SignerV4 import SignerV4
          ak=os.environ['AK']; sk=os.environ['SK']; region=os.environ.get('REGION','cn-beijing')
          albs=[('prod',os.environ.get('ALB_PROD','')),('staging',os.environ.get('ALB_STAGING','')),('dev',os.environ.get('ALB_DEV',''))]
          def presign(action, **query):
              ep=f"alb.{region}.volcengineapi.com"
              req=Request(); req.method='GET'; req.host=ep; req.path='/'
              q={'Action':action,'Version':'2020-04-01','Region':region}; q.update(query)
              req.query=q; req.headers={'Host':ep}
              cred=Credentials(ak, sk, service='alb', region=region)
              return f"https://{ep}/?"+SignerV4.sign_url(req, cred)
          def get(url): 
              return json.loads(urllib.request.urlopen(url, timeout=60).read().decode())
          out={}
          for name,alb in albs:
              if not alb: continue
              lst=get(presign('DescribeListeners', LoadBalancerId=alb))
              listeners=[{'ListenerId':i['ListenerId'],'Protocol':i['Protocol'],'Port':i['Port']} for i in lst['Result'].get('Listeners',[])]
              out[name]=listeners
          print(json.dumps(out, ensure_ascii=False, indent=2))
          open('alb-listeners.json','w').write(json.dumps(out, ensure_ascii=False, indent=2))
          PY
      - name: Host rules and health
        run: |
          export VE_AK="${AK}" VE_SK="${SK}" VE_REGION="${REGION}"
          export ALB_PROD="${ALB_PROD}" ALB_STAGING="${ALB_STAGING}" ALB_DEV="${ALB_DEV}"
          export HOSTS="yapi.chekkk.com,app.chekkk.com,www.chekkk.com,app-staging.chekkk.com,www-staging.chekkk.com,app-dev.chekkk.com,www-dev.chekkk.com"
          python tmp/alb_verify_hosts.py > alb-verify-hosts.json || true
      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: alb-nightly
          path: |
            alb-listeners.json
            alb-verify-hosts.json


