name: YApi Sync (Org-level LLM Enrichment)

on:
  workflow_dispatch:
    inputs:
      openapi_url:
        description: "OpenAPI JSON URL"
        required: true
        type: string

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ca-certificates curl jq

      - name: Import OpenAPI into YApi (if supported)
        env:
          YAPI_BASE: ${{ secrets.YAPI_BASE }} # e.g. https://yapi.chekkk.com
          YAPI_EMAIL: ${{ secrets.YAPI_EMAIL }} # admin or bot account
          YAPI_PASSWORD: ${{ secrets.YAPI_PASSWORD }}
          YAPI_TOKEN: ${{ secrets.YAPI_PROJECT_TOKEN }} # optional project token
          OPENAPI_URL: ${{ inputs.openapi_url }}
        run: |
          set -e
          : "${YAPI_BASE:?missing}"; : "${YAPI_EMAIL:?missing}"; : "${YAPI_PASSWORD:?missing}"
          COOKIE="$(mktemp)"
          curl -sS -c "$COOKIE" -H 'Content-Type: application/json' \
            -d "{\"email\":\"${YAPI_EMAIL}\",\"password\":\"${YAPI_PASSWORD}\"}" \
            "$YAPI_BASE/api/user/login" | jq -r '.errmsg' || true

          # Prefer official import endpoint if plugin enabled
          code=$(curl -sS -o /tmp/resp.json -w "%{http_code}" \
            "$YAPI_BASE/api/open/import_data?type=openapi&json_url=$(python3 - <<'PY'
import urllib.parse, os
print(urllib.parse.quote(os.environ.get("OPENAPI_URL",""), safe=""))
PY
)&merge=1&token=${YAPI_TOKEN}" || true)
          echo "import_data http_code=$code"
          head -n 1 /tmp/resp.json || true
          if jq -e 'select(.errcode==0)' /tmp/resp.json >/dev/null 2>&1; then
            echo "YApi: import_data succeeded"
            exit 0
          fi
          if jq -e 'select(.errcode==40022)' /tmp/resp.json >/dev/null 2>&1; then
            echo "YApi: import_data not supported on this instance (40022)."
            echo "Consider enabling OpenAPI import plugin or provide an alternative sync API."
            exit 0
          fi

          echo "YApi: import_data returned non-zero; see /tmp/resp.json"
          exit 1



