研发使用指南（统一约定与落地操作）


一、基本原则（必须遵守）
- 工具与入口
  - 飞连：统一 SSO 入口（GitHub、Argo CD、Grafana、VECR/Harbor、YApi、Nacos 等）。
  - 飞书文档：仅承载需要协同讨论/沉淀的活文档；代码仓内 Markdown 是执行说明的单一真源。
  - 飞书机器人：构建/发布/告警/回滚/审批/高危漏洞自动通知；Webhook/Secret 存于仓库 Secrets。
  - 代码与 CI：GitHub + Actions 为主（构建/扫描/签名/推镜像/触发 GitOps）。
- 命名与目录
  - 命名空间：`<product>-<env>`（如 `miker-dev/staging/prod`）。
  - Helm Release/目录：`<product>-<env>`；values 以环境分目录；infra 仓库为 GitOps 真源。
  - VPC：`chek-<purpose>-vpc-<nn>`（如 `chek-k8s-vpc-01`）。子网：`subnet-<env>-<az>-<cidr-suffix>`；路由表：`rt-<env>-<purpose>`；安全组：`sg-<env>-<purpose>`。
- 镜像与 VECR
  - 仓库：`chek-images-cn-beijing.cr.volces.com/<project>/<image>`；项目建议：平台基础镜像用 `devops/`，业务按产品分项目。
  - 标签：`vX.Y.Z`（生产）/ `sha-<short>`（日常）；禁止 `:latest`；记录镜像 digest 以便追溯。
  - 拉取：所有命名空间与系统组件必须配置 `imagePullSecrets: vecr-auth`。
- 容器基线
  - 固定基础镜像版本（如 `alpine:3.20`/`busybox:1.36`）；非 root 运行；只读根文件系统；必须有探针与资源配额。
- VPC 与出网（路由/NAT）
  - NAT：staging+dev 共用，prod 独享；私有子网默认 `0.0.0.0/0 → NAT`；NO_PROXY 包含 `.svc,.svc.cluster.local,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,localhost,127.0.0.1`。
  - 安全组：放通出站 TCP 443；CoreDNS 上游需要 UDP/TCP 53（可收敛到 1.1.1.1/8.8.8.8/114.114.114.114）。
- DNS 原则
  - 统一 CoreDNS（停用 node-local-dns），Upstream 使用 1.1.1.1/8.8.8.8/114.114.114.114；必要时可切 DoH/DoT。
- 安全与密钥
  - 机密通过 Secrets/SOPS/External Secrets/IRSA 管理；访问云资源统一 IRSA（OIDC 角色绑定）。
- 微服务复用
  - 优先“平台单份部署 + NetworkPolicy 白名单”（命名空间 `platform-<env>`），通过 ClusterIP DNS 复用。
- 发布与回滚
  - “PR → Actions 构建与安全扫描 → 推 VECR → 提交 infra 变更 → Argo CD 发布”；回滚以 GitOps 为准。
- CI 门禁对齐
  - 与 `commands/speckit.specify.md` 保持一致：Lint/TypeCheck/Test/Trivy/CodeQL/Gitleaks 为必过项；失败不发布；产出记录不可变 digest 与审计。

- 平台账号与治理（Nacos / YApi / Ingress‑NGINX）
  - Nacos：
    - 命名：Namespace `\<product>-\<env>`；Group 固定 `DEFAULT_GROUP`；Service `\<service>`；配置 `dataId`/`group` 同步于代码。
    - 账号：`nacos_rd`（只读）、`nacos_op`（可写）、`nacos_admin`（平台）；开发默认使用只读，变更通过 PR 与发布流程落地。
    - 密钥：以 `nacos-cred` Secret 下发（含 `address/username/password`），禁止明文。
  - YApi：
    - 命名：项目 `\<product>-\<env>`；接口分组按域/微服务；Token 仅用于 CI 同步。
    - 账号：`yapi_admin`（平台）、`yapi_owner_<product>`（产品负责人）、成员按最小权限加入；Token 存 Secrets。
  - Ingress‑NGINX：
    - 域名：`\<product>-dev|staging.chekkk.com`、`\<product>.chekkk.com`；TLS Secret `<product>-tls`；
    - 约束：默认限流/白名单可通过 Annotation 打开；与 Rollouts 配合使用两套 Service 做金丝雀。

二、装好一个环境需要注意的事项（以 miker-prod 为例）
- 现状/资源
  - 目标：按环境隔离（dev / staging / prod），产品按命名空间隔离，最小权限与配额控制。
  - 集群/VPC：
    - dev：既有 VKE（VPC `chek-k8s-vpc-01`）。
    - staging：既有 VKE（VPC `default`）。
    - prod：`chek-prod-k8s`（cd3dvl7dfro4clvq3ktt0；VPC `chek-k8s-vpc-01`；子网 172.31.120.0/24、172.31.121.0/24；安全组 `sg-iiyj5u0it0jk74o8cui4yuzf`）。
  - 命名空间命名：`<product>-<env>`（例：`miker-dev/staging/prod`）。
  - 资源配额：每命名空间配置 ResourceQuota/LimitRange、NetworkPolicy、IRSA（最小权限）。
- VPC 出口与 DNS（本次落地要点）
  - NAT：为 prod 新建 NAT 和 SNAT，独立 EIP；覆盖 172.31.120.0/24、172.31.121.0/24。
  - 安全组：放通 443；CoreDNS 上游需要 UDP/TCP 53；必要时收敛到三大公共 DNS。
  - DNS：卸载 node-local-dns；用 VECR 镜像重装 CoreDNS，Upstream 1.1.1.1/8.8.8.8/114.114.114.114；以 busybox `nslookup/curl` 验证。
- 入口与证书
  - Ingress‑NGINX：每集群一套；域名示例 `miker.chekkk.com`（prod）、`miker-staging.chekkk.com`、`miker-dev.chekkk.com`。
  - Cert‑Manager：`ClusterIssuer/letsencrypt-http`；业务侧创建 `Certificate` 引用；ACME 邮箱 `feilian@chekkk.com`；Secret 命名 `<product>-tls`。
- 配置与注册
  - 在 Nacos 为三环境建 namespace：`miker-dev/staging/prod`；拷贝模板配置并差异化。
  - 敏感项不明文：放 K8s Secret 或 External Secrets；服务元数据建议包含 `openapi_url/docs_url/owner/desc`。
- 数据库与缓存
  - 优先托管（RDS MySQL/PG/SQLServer、Redis）；变更审计后续接入 Archery；凭据发放走 External Secrets；访问由 NetworkPolicy 白名单控制。
  - 迁移：Helm Hook/Flyway/Liquibase/Mongock 等以 Job 形式执行，输出落 TOS 备份。
- 对象存储 TOS
  - 端点：`https://tos-<region>.volces.com`；路径：`s3://<bucket>/<product>/<env>/...`；优先 IRSA，CI 可临时 AK/SK。
  - K8s/CLI/Actions 的例子与权限命名、常见问题详见本文件 TOS 小节（保留原完整内容）。
- GitOps 与 CI/CD
  - GitHub Actions：构建/扫描/签名/推镜像；触发 GitOps。Argo CD：从 infra 下发 Helm/Kustomize；可视化与回滚。
  - 镜像仓库：VECR 为主（Harbor 作为补充）。包仓库：Nexus（后续上线）。
  - 仓库 Secrets：`REGISTRY_*`（VECR 登录）、`NACOS_*`、`TOS_*`、必要 DB 凭据（建议改 External Secrets）。
  - 流程：`dev → staging → 生产 tag → prod`；失败自动通知飞书机器人。
- ARC（Actions Runner Controller）
  - 控制器镜像与 `kube-rbac-proxy` 统一切到 VECR；`kube-rbac-proxy` 使用 `--tls-cert-file/--tls-private-key-file` 并挂载证书。
  - RunnerDeployment 设 `ephemeral: false`、`RUNNER_EPHEMERAL=false`、`replicas: 1`，组织 Runner Online。
- 平台一览（原文并入，便于“去哪做什么”）
  - 代码：GitHub Enterprise（chekdata 组织）。CI：GitHub Actions / Jenkins（如需）。
  - GitOps：Argo CD（按 `infra/` 管理）。API：YApi（115.190.149.158:3000）。
  - 镜像：VECR/Harbor。配置注册：Nacos（172.31.44.114:8848，私网）。观测：Grafana/Prometheus/Loki（待装）。

三、作为一个开发团队成员的操作流程（最短路径）
- 账号与入口
  - 用个人 GitHub 登录飞连完成授权，自动加入 `chekdata` 组织所需团队；本地常用 `gh/git/docker/kubectl(只读)`。
- 代码与分支
  - 分支：dev（开发）、staging（测试）、main（生产）。生产标签：`vX.Y.Z`/`vX.Y.Z-rc.N`；main 受保护（评审+CI+签名制品）。
- 新建/改造服务到上线
  - 用模板仓库（已内置在 `ops-bootstrap/templates/`）：
    - Actions：`templates/actions/ci-docker-vecr.yml`（构建并推 VECR）
    - Docker：`templates/docker/Dockerfile.node`、`.dockerignore`
    - Helm：`templates/helm/Chart.yaml`、`values.yaml`、`templates/{deployment,service}.yaml`
    - K8s：`templates/k8s/secret-nacos-cred.example.yaml`
  - 快速开始（示例，创建 `mysvc` 于 `miker-dev`）：
    ```bash
    cp -r ops-bootstrap/templates/helm miker.repo/charts/mysvc
    cp ops-bootstrap/templates/docker/Dockerfile.node miker.repo/Dockerfile
    cp ops-bootstrap/templates/docker/.dockerignore miker.repo/.dockerignore
    mkdir -p miker.repo/.github/workflows && \
      cp ops-bootstrap/templates/actions/ci-docker-vecr.yml miker.repo/.github/workflows/ci.yml
    # 替换占位符：<product>=miker <service>=mysvc <namespace>=miker-dev <imageRepo>=miker <port>=3000
    ```
  - Push→Actions 自动构建并推 VECR→提 PR 修改 infra 中 `<product>-<env>` 的镜像 tag→合并后 Argo CD 自动发布。
  - 配置放 Nacos，机密用 Secrets/External Secrets；访问云资源用 IRSA；对外暴露写 Ingress + Certificate。
- 日常排障
  - 集群：`kubectl -n <ns> get deploy,po,svc,ingress` 和 Argo CD UI；CoreDNS/出口优先用 busybox Pod `nslookup/curl` 验证。
  - 镜像：确认 imagePullSecrets 与 VECR 镜像存在；CI 失败看 Actions 日志与飞书卡片。
- 共享微服务接入
  - 直接访问 `service.platform-<env>.svc.cluster.local`；需跨产品白名单由平台添加 NetworkPolicy。
- 飞书机器人
  - 缺陷/需求：GitHub Issues + Projects（看板/里程碑），飞书机器人同步事件（Issues/PR/Workflow run）。
  - 机器人治理：配置与路由以代码管理（infra/.github）；事件路由与降噪规则沿用原文；成员同步工作流与映射文件保持不变。

四、QA（常见问答）
- Jenkins 还需要吗？
  - 主用 GitHub Actions 做 CI；仅当需要有状态 Agent 或特殊编排时短期保留 Jenkins，逐步迁移。
- 测试/缺陷如何管理？
  - GitHub Issues + Projects（看板/里程碑/模板）+ 飞书机器人；生产失败/告警必推送。
- 数据库变更如何管控？
  - RDS 优先；上线走变更/审计（后续接入 Archery）；应用侧用迁移 Job（Flyway/Liquibase/Mongock）并将输出落 TOS 归档。
- TOS 如何打通？
  - 统一 IRSA；CI 可临时 AK/SK；端点 `https://tos-<region>.volces.com`；路径 `s3://<bucket>/<product>/<env>/...`（详见本文件 TOS 小节）。
- DNS/NAT 常见问题
  - 组织 Runner注册报 `lookup api.github.com i/o timeout`：先 busybox 验证 `nslookup/curl`；若 DNS 超时，检查 CoreDNS Pod、kube-dns Endpoints、节点出站 53；若 HTTPS 超时，检查 NAT/SNAT 与安全组 443。

附录A：平台操作步骤与账号规范（精简版）
- Nacos
  1) 创建命名空间：`<product>-<env>`。
  2) 导入配置：按目录与 `dataId` 规范提交到代码库，发布时由 CI 同步；敏感项写入 K8s Secret 或 External Secrets。
  3) 创建账号与权限：
     - 只读：`nacos_rd`（给研发组）；可写：`nacos_op`（运维/发布机器人）。
     - 最小授权目标命名空间，避免全局写入。
  4) 下发到集群：
     ```bash
     kubectl -n <product>-<env> create secret generic nacos-cred \
       --from-literal=address=http://<nacos-host>:8848 \
       --from-literal=username=nacos_rd \
       --from-literal=password='***'
     ```

- YApi
  1) 新建项目：名称 `\<product>-\<env>`；设置负责人与成员（只读/编辑）。
  2) 导入：启用 Swagger 同步或上传 JSON；生成只读 Token 供 CI 使用。
  3) 安全：Token 存于仓库 Secrets（如 `YAPI_TOKEN_<ENV>`）。

- Ingress‑NGINX
  1) 证书：确保集群存在 `ClusterIssuer/letsencrypt-http`；业务侧创建 `Certificate`，Secret 命名 `<product>-tls`。
  2) Ingress 示例：
     ```yaml
     apiVersion: networking.k8s.io/v1
     kind: Ingress
     metadata:
       name: <product>-ing
       namespace: <product>-<env>
       annotations:
         kubernetes.io/ingress.class: nginx
         nginx.ingress.kubernetes.io/proxy-body-size: "8m"
     spec:
       tls:
       - hosts: ["<product>-<env>.chekkk.com"]
         secretName: <product>-tls
       rules:
       - host: <product>-<env>.chekkk.com
         http:
           paths:
           - path: /
             pathType: Prefix
             backend:
               service:
                 name: <service>
                 port:
                   number: 80
     ```
  3) 金丝雀：与 Argo Rollouts 的 `canary` Service 搭配（Ingress 指向 `stable`，按权重切换 `canary`）。

（附录）原文细节未动部分
- “TOS 访问指南”完整示例（K8s/CLI/Actions/权限/常见问题）保留在文末原位置，便于复制。
- “平台一览/成员同步/机器人模板”保留，按上述新目录定位。
