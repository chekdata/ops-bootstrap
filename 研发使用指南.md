研发使用指南（统一约定与落地操作）


一、基本原则（必须遵守）
- 工具与入口
  - 飞连：统一 SSO 入口（GitHub、Argo CD、Grafana、VECR/Harbor、YApi、Nacos 等）。
  - 飞书文档：仅承载需要协同讨论/沉淀的活文档；代码仓内 Markdown 是执行说明的单一真源。
  - 飞书机器人：构建/发布/告警/回滚/审批/高危漏洞自动通知；Webhook/Secret 存于仓库 Secrets。
  - 代码与 CI：GitHub + Actions 为主（构建/扫描/签名/推镜像/触发 GitOps）。
- 命名与目录
  - 命名空间：`<product>-<env>`（如 `miker-dev/staging/prod`）。
  - Helm Release/目录：`<product>-<env>`；values 以环境分目录；infra 仓库为 GitOps 真源。
  - VPC：`chek-<purpose>-vpc-<nn>`（如 `chek-k8s-vpc-01`）。子网：`subnet-<env>-<az>-<cidr-suffix>`；路由表：`rt-<env>-<purpose>`；安全组：`sg-<env>-<purpose>`。
- 镜像与 VECR
  - 仓库：`chek-images-cn-beijing.cr.volces.com/<project>/<image>`；项目建议：平台基础镜像用 `devops/`，业务按产品分项目。
  - 标签：`vX.Y.Z`（生产）/ `sha-<short>`（日常）；禁止 `:latest`；记录镜像 digest 以便追溯。
  - 拉取：所有命名空间与系统组件必须配置 `imagePullSecrets: vecr-auth`。
- 容器基线
  - 固定基础镜像版本（如 `alpine:3.20`/`busybox:1.36`）；非 root 运行；只读根文件系统；必须有探针与资源配额。
- VPC 与出网（路由/NAT）
  - NAT：staging+dev 共用，prod 独享；私有子网默认 `0.0.0.0/0 → NAT`；NO_PROXY 包含 `.svc,.svc.cluster.local,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,localhost,127.0.0.1`。
  - 安全组：放通出站 TCP 443；CoreDNS 上游需要 UDP/TCP 53（可收敛到 1.1.1.1/8.8.8.8/114.114.114.114）。
- DNS 原则
  - 统一 CoreDNS（停用 node-local-dns），Upstream 使用 1.1.1.1/8.8.8.8/114.114.114.114；必要时可切 DoH/DoT。
- 安全与密钥
  - 机密通过 Secrets/SOPS/External Secrets/IRSA 管理；访问云资源统一 IRSA（OIDC 角色绑定）。
- 微服务复用
  - 优先“平台单份部署 + NetworkPolicy 白名单”（命名空间 `platform-<env>`），通过 ClusterIP DNS 复用。
- 发布与回滚
  - “PR → Actions 构建与安全扫描 → 推 VECR → 提交 infra 变更 → Argo CD 发布”；回滚以 GitOps 为准。
- CI 门禁对齐
  - 与 `commands/speckit.specify.md` 保持一致：Lint/TypeCheck/Test/Trivy/CodeQL/Gitleaks 为必过项；失败不发布；产出记录不可变 digest 与审计。

 - 平台账号与治理（Nacos / YApi / Ingress‑NGINX）
  - Nacos（MSE 托管优先）：
    - 选型：prod/staging/dev 优先使用火山引擎 MSE 托管版 Nacos；仅在合规或成本要求下自建。
    - 隔离：Namespace 使用 `\<product>-\<env>`（如 `miker-prod/staging/dev`）；业务用 Group（如 `miker`/`common`）；DataId 以 “应用-场景.yaml” 命名并与代码同源管理。
    - 访问与安全：仅开放 VPC；开启登录鉴权；账号分级 `nacos_rd`（只读）/`nacos_op`（发布）/`nacos_admin`（平台）；最小权限；以 `nacos-cred` Secret 下发 `address/username/password`，禁止明文。
    - 变更流程：配置必须走 Git→CI 校验（lint/模板）→审批→自动发布到 MSE；禁止控制台直接改配置。
    - 客户端：`spring.cloud.nacos.*` 指向 MSE 内网域名；心跳 5–10s；实例保护阈值按流量评估慎用；超时/重试采用官方默认或经压测调优。
    - 监控与告警：启用 MSE 自带监控和告警；关键事件（发布/回滚/异常）接入飞书机器人。
    - 备份与数据：托管优先使用 MSE 内置 MySQL；如自建，外置 RDS 并开启每日备份；重大发布前手动快照。
    - 自建 fallback（如必须）：生产 3 副本 + 外部 MySQL；非生产 1 副本或 3 小副本；镜像固定 `nacos/nacos-server:2.3.2` 并镜像到 VECR。
  - YApi：
    - 命名：项目 `\<product>-\<env>`；接口分组按域/微服务；Token 仅用于 CI 同步。
    - 账号：`yapi_admin`（平台）、`yapi_owner_<product>`（产品负责人）、成员按最小权限加入；Token 存 Secrets。
  - Ingress‑NGINX：
    - 域名：`\<product>-dev|staging.chekkk.com`、`\<product>.chekkk.com`；TLS Secret `<product>-tls`；
    - 约束：默认限流/白名单可通过 Annotation 打开；与 Rollouts 配合使用两套 Service 做金丝雀。

二、装好一个环境需要注意的事项（以 miker-prod 为例）
- 现状/资源
  - 目标：按环境隔离（dev / staging / prod），产品按命名空间隔离，最小权限与配额控制。
  - 集群/VPC：
    - dev：既有 VKE（VPC `chek-k8s-vpc-01`）。
    - staging：既有 VKE（VPC `default`）。
    - prod：`chek-prod-k8s`（cd3dvl7dfro4clvq3ktt0；VPC `chek-k8s-vpc-01`；子网 172.31.120.0/24、172.31.121.0/24；安全组 `sg-iiyj5u0it0jk74o8cui4yuzf`）。
  - 命名空间命名：`<product>-<env>`（例：`miker-dev/staging/prod`）。
- 资源配额：每命名空间配置 ResourceQuota/LimitRange、NetworkPolicy、IRSA（最小权限）。
- VPC 出口与 DNS（本次落地要点）
  - NAT：为 prod 新建 NAT 和 SNAT，独立 EIP；覆盖 172.31.120.0/24、172.31.121.0/24。
  - 安全组：放通 443；CoreDNS 上游需要 UDP/TCP 53；必要时收敛到三大公共 DNS。
  - DNS：卸载 node-local-dns；用 VECR 镜像重装 CoreDNS，Upstream 1.1.1.1/8.8.8.8/114.114.114.114；以 busybox `nslookup/curl` 验证。
- 入口与证书
  - Ingress‑NGINX：每集群一套；域名示例 `miker.chekkk.com`（prod）、`miker-staging.chekkk.com`、`miker-dev.chekkk.com`。
  - 端口规范（强制）：Service 端口命名 `http`，`targetPort` 指向容器端口（推荐 3000）；Ingress backend 使用 `port.name: http`，避免 502（端口漂移）。
  - Admission：长期 `failurePolicy=Fail`；必要时临时 `Ignore` 应急，操作完即恢复。
  - 镜像源：controller 与 certgen 镜像走 VECR/国内镜像源并固定版本（如 controller v1.10.1、certgen v1.4.1）。

- OpenAPI 脚本化创建资源（Volcengine 最小实践）
  - 认证与公共参数：统一走 `open.volcengineapi.com` 或服务专属域；签名使用 AK/SK；所有请求带 `Action`、`Version`、`Region`。
  - NAT 网关
    - 创建：服务 `natgateway`，端点 `https://natgateway.<region>.volcengineapi.com`，`Action=CreateNatGateway`，`Version=2020-04-01`。
    - 关键参数：`NatGatewayName`、`VpcId`、`SubnetId`、`Spec=Small`。
    - 绑定 EIP：优先使用 EIP 服务 `AssociateEipAddress`（服务 `eip`，`Version=2020-04-01`，参数：`AllocationId`、`InstanceType=Nat`、`InstanceId=<NAT_ID>`）。
    - 创建 SNAT：`CreateSnatEntry`（服务 `natgateway`，`Version=2020-04-01`）；常用参数：`NatGatewayId`、`SubnetId` 或 `SourceCIDR`、以及 `AllocationId` 或 `PublicIpAddresses.N`。
    - 文档参考：NAT 网关与 SNAT 规则 [文档](https://www.volcengine.com/docs/6404/198717)。
  - VKE 集群
    - 创建：服务 `vke`，端点 `https://open.volcengineapi.com`，`Action=CreateCluster`，`Version=2022-05-12`。
    - 最小可行参数（Flannel 示意）：
      - `ClusterConfig`: `VpcId`、`ClusterType=Managed`、`KubernetesVersion`、`SubnetIds`。
      - `PodsConfig.FlannelConfig.PodCidrs=["172.20.0.0/16"]`（各环境避免冲突）。
      - `ServicesConfig.ServiceCidrsv4=["10.96.0.0/12"]`。
    - 创建节点池：`Action=CreateNodePool`（同 `Version`）。
      - 核心：`SubnetIds`、`InstanceTypeIds`、`KubernetesConfig.MaxPodsPerNode`、`Security.Login`（密码或密钥对登录，按文档允许的字段形态填写）。
      - 若字段校验严格，建议在控制台校验一次参数组合（密码策略、卷类型枚举等），再回填到脚本。
    - 生成 kubeconfig：`Action=CreateKubeconfig`，建议 `Type=Private`、`IpAddressType=Ipv4`；或用 `ListKubeconfigs` 查询已有条目。
    - 文档参考：创建集群/节点池/Kubeconfig [CreateCluster](https://www.volcengine.com/docs/6460/100936) / [CreateNodePool](https://www.volcengine.com/docs/6460/115194) / [CreateKubeconfig](https://www.volcengine.com/docs/6460/163034)。
  - 超时与重试：EIP/NAT/VKE 接口偶发超时或 404/InvalidAction，请：
    - 固定稳定 `Version`；
    - 增大连接/读取超时与重试（3–5 次指数退避）；
    - 必要时切换到控制台创建，随后用 OpenAPI 查询并回填资源 ID（NAT/VKE/EIP）。
- 配置与注册
  - 在 Nacos 为三环境建 namespace：`miker-dev/staging/prod`；拷贝模板配置并差异化。
  - 敏感项不明文：放 K8s Secret 或 External Secrets；服务元数据建议包含 `openapi_url/docs_url/owner/desc`。

- 命名与标签规范（云资源）
  - 集群与节点池
    - 集群：`chek-<env>-k8s`（例：`chek-dev-k8s`、`chek-staging-k8s`）。
    - 节点池：`<env>-default-pool` 或 `<env>-<purpose>-pool`（例：`dev-default-pool`）。
  - 网络与出网
    - VPC：`chek-<purpose>-vpc-<nn>`（例：`chek-k8s-vpc-01`）。
    - 子网：`subnet-<env>-<az>-<cidr-suffix>`（例：`subnet-dev-a-110`）。
    - NAT 网关：`nat-<env>-egress-<nn>`（例：`nat-dev-egress-01`、`nat-staging-egress-01`）。
    - EIP：`eip-<product>-<env>-egress-<nn>`（例：`eip-miker-dev-egress-01`）。
    - 安全组：`sg-<env>-<purpose>`（例：`sg-dev-k8s`）。
  - 标签建议（所有资源）
    - `project=miker`、`env=<dev|staging|prod>`、`owner=platform`、`purpose=<k8s|egress|db|cache>`。
  - 域名与证书
    - 业务域：`<product>-<env>.chekkk.com`；生产 `miker.chekkk.com`。
    - TLS Secret：`<product>-tls`；ClusterIssuer：`letsencrypt-http` 或平台内置。
- 数据库与缓存
  - 优先托管（RDS MySQL/PG/SQLServer、Redis）；变更审计后续接入 Archery；凭据发放走 External Secrets；访问由 NetworkPolicy 白名单控制。
  - 迁移：Helm Hook/Flyway/Liquibase/Mongock 等以 Job 形式执行，输出落 TOS 备份。
- 对象存储 TOS
  - 长期主义：每“区域”一个桶，统一前缀，不按环境复制数据。
    - 北京集群：桶 `chek-app-assets`（cn-beijing）；前缀 `app_project_pic/` 为封面/头像等静态资源唯一真源。
    - 所有环境统一读取该前缀；仅 prod 允许写入（dev/staging 只读）。如需沙箱上传，使用独立前缀 `dev-test/`。
  - 访问与权限：
    - 端点：`https://tos-<region>.volces.com`（同区解析，配 VPC Endpoint 走私网）。
    - IRSA 最小权限（示例，prod）：
      - ListBucket 条件：`s3:prefix = app_project_pic/*`
      - 对象：`arn:aws:s3:::chek-app-assets/app_project_pic/*` 的 `GetObject/PutObject/AbortMultipartUpload`
    - dev/staging 仅 `List/Get`；禁止 `Put`（或仅允许 `dev-test/*`）。
  - 部署约定（vehicle-model-service）：
    - `TOS_ENDPOINT=https://tos-cn-beijing.volces.com`
    - `TOS_BUCKET=chek-app-assets`
    - `TOS_PREFIX=app_project_pic`
  - CDN/域名：统一一个加速域名（如 `assets.miker.chekkk.com`）指向该桶/前缀；各环境共用 URL，避免漂移与同步问题。
  - CI：如需构件归档可临时用 AK/SK；业务运行时统一 IRSA。
  - 参考：K8s/CLI/Actions 用法与常见问题见文末 TOS 小节示例。
- 监控工作区（Prometheus/VMP）
  - 当前约定：统一一个工作区 `platform-all`（dev/staging/prod 共用），便于快速落地与集中看板/告警。
  - 何时拆分：出现独立告警/权限/留存需求，或非生产指标体量/压测明显增大时，拆分为 `platform-prod` 与 `platform-nonprod`（必要时扩展到 dev/staging/prod 三套）。
  - 绑定：基础组件（Nacos、Ingress、ARC 等）创建时绑定该工作区；告警统一路由到飞书机器人。
- GitOps 与 CI/CD
  - GitHub Actions：构建/扫描/签名/推镜像；触发 GitOps。Argo CD：从 infra 下发 Helm/Kustomize；可视化与回滚。
  - 镜像仓库：VECR 为主（Harbor 作为补充）。包仓库：Nexus（后续上线）。
  - 仓库 Secrets：`REGISTRY_*`（VECR 登录）、`NACOS_*`、`TOS_*`、必要 DB 凭据（建议改 External Secrets）。
  - 流程：`dev → staging → 生产 tag → prod`；失败自动通知飞书机器人。
  - 分支策略与保护：
    - 分支映射：`dev`→开发环境、`staging`→预发、`main` 打 tag→生产。
    - 命名规范：`feature/<issue>-<desc>`、`fix/<incident>-<desc>`、`chore/<task>`、`docs/<topic>`、`refactor/<module>`。
    - 保护规则：`main/staging` 受保护（必须评审、必须通过检查、禁止直推、要求线性历史与对话已解决）；可选保护 `dev`。
    - 必跑检查：Lint/TypeCheck/Test/Trivy/CodeQL/Gitleaks；Actions 工作流提供统一入口（可按项目渐进收紧）。
    - 自动化：开启合并后自动删除分支；90 天未更新分支标记过期并清理。
- ARC（Actions Runner Controller）
  - 控制器镜像与 `kube-rbac-proxy` 统一切到 VECR；`kube-rbac-proxy` 使用 `--tls-cert-file/--tls-private-key-file` 并挂载证书。
  - RunnerDeployment 设 `ephemeral: false`、`RUNNER_EPHEMERAL=false`、`replicas: 1`，组织 Runner Online。
  - 常见问题与排障（本次实战）：
    - Runner 容器启动即退出 `ExitCode=0`：使用了原生 `actions/actions-runner` 镜像，缺少 ARC wrapper。改用 `summerwind/actions-runner` 并镜像到 VECR。
    - GHCR `manifest unknown`：`ghcr.io/actions-runner-controller/actions-runner:2.321.0` 标签不存在；改走 Docker Hub `summerwind/actions-runner` 并同步到 VECR。
    - 集群拉取 Docker Hub 超时：出网到 Docker Hub 受限；在 CI 拉取后推 VECR，由集群从 VECR 拉取。
    - DNS/HTTPS 超时或 `lookup api.github.com i/o timeout`：重装 CoreDNS，`dnsPolicy: None` + `dnsConfig` 指定上游（1.1.1.1/8.8.8.8/114.114.114.114），放通 53/443；用 busybox `nslookup/curl/openssl s_client` 验证。
    - `workVolumeClaimTemplate must be specified in container mode kubernetes`：如用 `containerMode: kubernetes` 需提供 `workVolumeClaimTemplate`；否则改用 `dockerdWithinRunnerContainer: true`/`dockerEnabled: true`。
    - `kube-rbac-proxy`：替换参数为 `--secure-listen-address/--tls-cert-file/--tls-private-key-file` 并挂载证书；移除多余代理环境变量。
    - 版本与参数：固定 runner 镜像版本（避免 `:latest` 漂移）；设置 `DISABLE_RUNNER_UPDATE=true`、必要时 `RUNNER_URL` 指向目标仓库/组织。
    - 在线验证：用 GitHub API `/repos/<org>/<repo>/actions/runners` 查看 `status=online busy=false`；Pod 日志应出现 `Listening for Jobs`。
- 平台一览（原文并入，便于“去哪做什么”）
  - 代码：GitHub Enterprise（chekdata 组织）。CI：GitHub Actions / Jenkins（如需）。
  - GitOps：Argo CD（按 `infra/` 管理）。API：YApi（115.190.149.158:3000）。
  - 镜像：VECR/Harbor。配置注册：Nacos（172.31.44.114:8848，私网）。观测：Grafana/Prometheus/Loki（待装）。

三、作为一个开发团队成员的操作流程（最短路径）
- 账号与入口
  - 用个人 GitHub 登录飞连完成授权，自动加入 `chekdata` 组织所需团队；本地常用 `gh/git/docker/kubectl(只读)`。
- 代码与分支
  - 分支：dev（开发）、staging（测试）、main（生产）。生产标签：`vX.Y.Z`/`vX.Y.Z-rc.N`；main 受保护（评审+CI+签名制品）。
- 新建/改造服务到上线
  - 用模板仓库（已内置在 `ops-bootstrap/templates/`）：
    - Actions：`templates/actions/ci-docker-vecr.yml`（构建并推 VECR）
    - Docker：`templates/docker/Dockerfile.node`、`.dockerignore`
    - Helm：`templates/helm/Chart.yaml`、`values.yaml`、`templates/{deployment,service}.yaml`
    - K8s：`templates/k8s/secret-nacos-cred.example.yaml`
  - 快速开始（示例，创建 `mysvc` 于 `miker-dev`）：
    ```bash
    cp -r ops-bootstrap/templates/helm miker.repo/charts/mysvc
    cp ops-bootstrap/templates/docker/Dockerfile.node miker.repo/Dockerfile
    cp ops-bootstrap/templates/docker/.dockerignore miker.repo/.dockerignore
    mkdir -p miker.repo/.github/workflows && \
      cp ops-bootstrap/templates/actions/ci-docker-vecr.yml miker.repo/.github/workflows/ci.yml
    # 替换占位符：<product>=miker <service>=mysvc <namespace>=miker-dev <imageRepo>=miker <port>=3000
    ```
  - Push→Actions 自动构建并推 VECR→提 PR 修改 infra 中 `<product>-<env>` 的镜像 tag→合并后 Argo CD 自动发布。
  - 配置放 Nacos，机密用 Secrets/External Secrets；访问云资源用 IRSA；对外暴露写 Ingress + Certificate。
- 日常排障
  - 503/502 快速流程：检查 Service selector → Endpoints（Ready/NotReady）→ Service targetPort 与容器端口 → Ingress backend 是否用 `name: http` → 控制器日志（无 endpoints/连接拒绝）。
  - 集群：`kubectl -n <ns> get deploy,po,svc,ingress` 和 Argo CD UI；CoreDNS/出口优先用 busybox `nslookup/curl` 验证；若命名空间有 ResourceQuota，优先在 `ingress-nginx` 或 `default` 运行临时 Pod。
  - 镜像：确认 imagePullSecrets 与 VECR 镜像存在；CI 失败看 Actions 日志与飞书卡片。
- 共享微服务接入
  - 直接访问 `service.platform-<env>.svc.cluster.local`；需跨产品白名单由平台添加 NetworkPolicy。
- 飞书机器人
  - 缺陷/需求：GitHub Issues + Projects（看板/里程碑），飞书机器人同步事件（Issues/PR/Workflow run）。
  - 机器人治理：配置与路由以代码管理（infra/.github）；事件路由与降噪规则沿用原文；成员同步工作流与映射文件保持不变。

### CI 构建与飞书通知（要点与操作手册）
- 关键实践（已验证）
  - CI 构建：使用 `docker/login-action@v3`、`docker/setup-buildx-action@v3`、`docker/build-push-action@v6`；VECR 登录凭据由 `REGISTRY_ENDPOINT/USERNAME/PASSWORD` Secrets 提供；镜像标签用 `sha-<short>`。
  - Actions 策略兼容：若出现 “0 jobs/failure before steps”，优先回退到上述稳定 actions 组合，并确认仓库/组织策略允许使用这些官方 actions。
  - 网络与 DNS：VECR/DockerHub/GitHub 访问异常，优先检查 CoreDNS 上游与出网 53/443，再查看 NAT/SNAT 与安全组规则。
  - 分支保护与必需检查：`main/staging` 保护，Required Checks 覆盖 Lint/Type/Unit/Trivy/CodeQL；合并后自动删分支。
- 通知链路（feishu-notify）
  - 触发：`feishu-notify.yml` 由 `on: workflow_run` 监听 `workflows: ["ci"] types: [completed]` 触发；建议同时加 `workflow_dispatch` 便于手动验证。
  - 环境映射：`main→prod`、`develop→dev`、`staging*→staging`，据此选择 `FEISHU_CHAT_ID_PROD/FEISHU_CHAT_ID_DEVSTG/FEISHU_CHAT_ID`。
  - 必需 Secrets：`FEISHU_APP_ID/FEISHU_APP_SECRET`、`FEISHU_CHAT_ID_*`（群 chat_id，形如 `oc_...`，且应用必须在群里）。
  - 报文格式：使用 `msg_type=interactive`；`content` 必须是“卡片 JSON 的字符串”（而非对象）。常见错误：
    - 9499 Invalid parameter type in json: content → 将卡片对象转成字符串（如 `jq -Rs .`）。
    - 230001 invalid receive_id → 校验 chat_id 是否为有效群 ID，且应用已加入群。
  - 降级与重试：建议失败时自动降级为 `msg_type=text` 并重试 3 次（指数退避），日志打印 `code/log_id`。
- 快速排障清单
  - CI 登录 VECR 失败：检查三项 `REGISTRY_*` Secrets 是否存在、可用；确认 `docker/login-action@v3` 在组织策略下被允许。
  - Buildx 下载失败：固定使用 `setup-buildx-action@v3`，避免漂移。
  - CI 触发不了：为 `ci.yml` 加 `workflow_dispatch`，网页端手动 Run Workflow 验证；若本地推送不稳定，改用 SSH key（ssh.github.com:443）或直接网页提交。
  - 未收到飞书：看 `feishu-notify` 任务日志的 Feishu API 返回码；定位 9499/230001 按上面处理；确认应用在群内。

四、QA（常见问答）
- Jenkins 还需要吗？
  - 主用 GitHub Actions 做 CI；仅当需要有状态 Agent 或特殊编排时短期保留 Jenkins，逐步迁移。
- 测试/缺陷如何管理？
  - GitHub Issues + Projects（看板/里程碑/模板）+ 飞书机器人；生产失败/告警必推送。
- 数据库变更如何管控？
  - RDS 优先；上线走变更/审计（后续接入 Archery）；应用侧用迁移 Job（Flyway/Liquibase/Mongock）并将输出落 TOS 归档。
- TOS 如何打通？
  - 统一 IRSA；CI 可临时 AK/SK；端点 `https://tos-<region>.volces.com`；路径 `s3://<bucket>/<product>/<env>/...`（详见本文件 TOS 小节）。
- DNS/NAT 常见问题
  - 组织 Runner注册报 `lookup api.github.com i/o timeout`：先 busybox 验证 `nslookup/curl`；若 DNS 超时，检查 CoreDNS Pod、kube-dns Endpoints、节点出站 53；若 HTTPS 超时，检查 NAT/SNAT 与安全组 443。

附录A：平台操作步骤与账号规范（精简版）
- Nacos
  1) 创建命名空间：`<product>-<env>`。
  2) 导入配置：按目录与 `dataId` 规范提交到代码库，发布时由 CI 同步；敏感项写入 K8s Secret 或 External Secrets。
  3) 创建账号与权限：
     - 只读：`nacos_rd`（给研发组）；可写：`nacos_op`（运维/发布机器人）。
     - 最小授权目标命名空间，避免全局写入。
  4) 下发到集群：
     ```bash
     kubectl -n <product>-<env> create secret generic nacos-cred \
       --from-literal=address=http://<nacos-host>:8848 \
       --from-literal=username=nacos_rd \
       --from-literal=password='***'
     ```

- YApi
  1) 新建项目：名称 `\<product>-\<env>`；设置负责人与成员（只读/编辑）。
  2) 导入：启用 Swagger 同步或上传 JSON；生成只读 Token 供 CI 使用。
  3) 安全：Token 存于仓库 Secrets（如 `YAPI_TOKEN_<ENV>`）。

- Ingress‑NGINX
  1) 证书：确保集群存在 `ClusterIssuer/letsencrypt-http`；业务侧创建 `Certificate`，Secret 命名 `<product>-tls`。
  2) Ingress 示例：
     ```yaml
     apiVersion: networking.k8s.io/v1
     kind: Ingress
     metadata:
       name: <product>-ing
       namespace: <product>-<env>
       annotations:
         kubernetes.io/ingress.class: nginx
         nginx.ingress.kubernetes.io/proxy-body-size: "8m"
     spec:
       tls:
       - hosts: ["<product>-<env>.chekkk.com"]
         secretName: <product>-tls
       rules:
       - host: <product>-<env>.chekkk.com
         http:
           paths:
           - path: /
             pathType: Prefix
             backend:
               service:
                 name: <service>
                 port:
                   number: 80
     ```
  3) 金丝雀：与 Argo Rollouts 的 `canary` Service 搭配（Ingress 指向 `stable`，按权重切换 `canary`）。

（附录）原文细节未动部分
- “TOS 访问指南”完整示例（K8s/CLI/Actions/权限/常见问题）保留在文末原位置，便于复制。
- “平台一览/成员同步/机器人模板”保留，按上述新目录定位。


## 飞书企业邮箱映射（生成与同步）
- 脚本：`scripts/gen_feishu_mapping_from_xlsx.py`
- 输入：飞书后台导出的通讯录 Excel（示例：`tmp/车控CHEK-通讯录-导出.xlsx`）
- 输出：`mappings/feishu_userid_to_enterprise_email.yaml`
- 使用：
  ```bash
  python3 -m pip install openpyxl pyyaml
  python3 scripts/gen_feishu_mapping_from_xlsx.py --input tmp/车控CHEK-通讯录-导出.xlsx
  ```
- 建议频率：组织成员更新后手动生成一次；或接入自动同步后周更。

## 飞书群命名规范（alerts / deploys）
- 命名规则：`<project>-<env>-<purpose>[-<region>]`，全部小写、用连字符连接。
  - 例如：`miker-prod-alerts-cn-bj`、`miker-prod-deploys`、`benchmark-prod-alerts`。
- 用途枚举：`alerts`（告警）/ `deploys`（发布）/ `incidents`（事故）/ `ops`（运维）。
- 机器人治理：
  - 统一把机器人加入 `alerts` 与 `deploys` 两类群。
  - 生产 P0 告警群开启必达与@所有人限制，值班责任到人。
  - 群描述中写明“负责人/用途/关联系统”。

## Nacos 使用范围与接入规则
- 适用范围：仅用于后端微服务的注册发现与配置管理；前端（如 `miker` Web 前台）不直接接入 Nacos。
- 平台共享：采用 MSE 托管 Nacos，平台共享一个实例，按 `namespace=<project>-<env>` 做隔离（如 `miker-prod`、`benchmark-prod`）。
- 客户端指引：
  - 统一 Nacos 接入地址（推荐 CNAME，如 `nacos.platform.chekkk.com:8848`），各环境通过 `NACOS_NAMESPACE` 区分。
  - Spring Cloud Alibaba：配置 `spring.cloud.nacos.discovery.*` 与 `spring.cloud.nacos.config.*` 指向平台地址，敏感凭据通过 Secret/External Secrets 下发。
- 不适用项：
  - 业务入口域名（`miker.chekkk.com`、`benchmark.chekkk.com`）不指向 Nacos。
  - 前端运行时配置走环境变量/ConfigMap/CDN，不从 Nacos 直接读取。

